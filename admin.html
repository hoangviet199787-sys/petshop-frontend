<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - Pet House</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #343a40; padding-top: 20px; color: white; z-index: 1000; }
        .sidebar .nav-link { padding: 15px 25px; font-size: 1rem; color: #cfd8dc; cursor: pointer; transition: 0.3s; border-radius: 0; display: block; width: 100%; text-align: left; background: none; border: none; }
        .sidebar .nav-link:hover { background-color: #495057; color: white; }
        .sidebar .nav-link.active { background-color: #0d6efd; color: white; border-right: 4px solid #fff; }
        .brand { text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; color: #ffc107; text-transform: uppercase; }
        .main-content { margin-left: 250px; padding: 30px; }
        .tab-section { display: none; } .tab-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .table img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .table td { vertical-align: middle; }
        .stat-card { border: none; border-radius: 15px; padding: 25px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
        
        /* Tr·∫°ng th√°i ƒë∆°n h√†ng */
        .status-pending { background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        .status-shipping { background: #cce5ff; color: #004085; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        .status-done { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        .status-cancel { background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        
        #pagination button { background: white; border: 1px solid #dee2e6; color: #333; padding: 5px 12px; margin: 0 2px; border-radius: 4px; }
        #pagination button.active { background: #0d6efd; color: white; border-color: #0d6efd; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-paw"></i> Pet Admin</div>
        <div class="nav flex-column">
            <button class="nav-link active" onclick="switchTab(event, 'dashboard-tab'); loadDashboard()">
                <i class="fas fa-chart-line me-2"></i> T·ªïng quan
            </button>
            <button class="nav-link" onclick="switchTab(event, 'products-tab'); loadProducts()">
                <i class="fas fa-box-open me-2"></i> Kho H√†ng
            </button>
            <button class="nav-link" onclick="switchTab(event, 'orders-tab'); loadOrders()">
                <i class="fas fa-shopping-cart me-2"></i> ƒê∆°n H√†ng
            </button>
            <a href="index.html" class="nav-link text-warning mt-5"><i class="fas fa-external-link-alt me-2"></i> Xem Web Ch√≠nh</a>
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard-tab" class="tab-section active">
            <h3 class="mb-4 fw-bold">üìä T·ªïng quan kinh doanh</h3>
            <div class="row g-4 mb-5">
                <div class="col-md-4"><div class="stat-card bg-gradient-success"><div><h6>DOANH THU</h6><h2 class="fw-bold mb-0" id="stat-revenue">0ƒë</h2></div><i class="fas fa-wallet fa-3x opacity-50"></i></div></div>
                <div class="col-md-4"><div class="stat-card bg-gradient-primary"><div><h6>T·ªîNG ƒê∆†N</h6><h2 class="fw-bold mb-0" id="stat-orders">0</h2></div><i class="fas fa-shopping-bag fa-3x opacity-50"></i></div></div>
                <div class="col-md-4"><div class="stat-card bg-gradient-warning"><div><h6>S·∫¢N PH·∫®M</h6><h2 class="fw-bold mb-0" id="stat-products">0</h2></div><i class="fas fa-cubes fa-3x opacity-50"></i></div></div>
            </div>
        </div>

        <div id="products-tab" class="tab-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">üì¶ Kho h√†ng (Server)</h3>
                <button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus-circle"></i> Th√™m m√≥n m·ªõi</button>
            </div>
            <div class="card p-4 shadow-sm">
                <table class="table table-hover align-middle">
                    <thead class="table-dark"><tr><th>·∫¢nh</th><th>T√™n s·∫£n ph·∫©m</th><th>Gi√°</th><th>Danh m·ª•c</th><th>H√†nh ƒë·ªông</th></tr></thead>
                    <tbody id="product-list"></tbody>
                </table>
                <div id="pagination" class="d-flex justify-content-center mt-3 gap-2"></div>
            </div>
        </div>

        <div id="orders-tab" class="tab-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-primary">‚ö° ƒê∆°n H√†ng C·∫ßn X·ª≠ L√Ω</h3>
                <button class="btn btn-sm btn-danger" onclick="clearOrders()"><i class="fas fa-trash"></i> Reset</button>
            </div>
            
            <div class="card p-3 shadow-sm mb-5 border-primary border-2">
                <table class="table table-hover align-middle">
                    <thead class="bg-light"><tr><th>M√£</th><th>Kh√°ch h√†ng & Giao t·ªõi</th><th>Chi ti·∫øt & Thanh to√°n</th><th>T·ªïng</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead>
                    <tbody id="active-order-body"></tbody>
                </table>
                <div id="empty-active-msg" class="text-center text-muted p-3">Kh√¥ng c√≥ ƒë∆°n h√†ng c·∫ßn x·ª≠ l√Ω!</div>
            </div>

            <h4 class="fw-bold text-secondary">L·ªãch S·ª≠ ƒê∆°n H√†ng</h4>
            <div class="card p-3 shadow-sm bg-light">
                <table class="table table-hover align-middle text-muted">
                    <thead><tr><th>M√£</th><th>Kh√°ch</th><th>Chi ti·∫øt</th><th>T·ªïng</th><th>K·∫øt qu·∫£</th></tr></thead>
                    <tbody id="history-order-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modalTitle">S·∫£n ph·∫©m</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="productForm">
                <input type="hidden" id="p-id">
                <div class="mb-3"><label>T√™n</label><input type="text" class="form-control" id="p-name" required></div>
                <div class="mb-3"><label>Gi√°</label><input type="number" class="form-control" id="p-price" required></div>
                <div class="mb-3"><label>Link ·∫¢nh</label><input type="text" class="form-control" id="p-image" required></div>
                <div class="mb-3"><label>Danh m·ª•c</label><select class="form-select" id="p-category"><option>Th·ª©c ƒÉn</option><option>Ph·ª• ki·ªán</option><option>V·ªá sinh</option></select></div>
                <button type="submit" class="btn btn-primary w-100 fw-bold" id="btnSave">L∆ØU S·∫¢N PH·∫®M</button>
            </form>
        </div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://petshop-api-3uon.onrender.com/api";
        const DEFAULT_IMG = "https://cdn-icons-png.flaticon.com/512/3047/3047928.png";
        let productModalBox, allProducts = [], currentPage = 1, itemsPerPage = 6, editingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            productModalBox = new bootstrap.Modal(document.getElementById('productModal'));
            loadDashboard();
        });

        function switchTab(event, tabId) {
            document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tabId === 'products-tab') loadProducts();
            if(tabId === 'orders-tab') loadOrders();
            if(tabId === 'dashboard-tab') loadDashboard();
        }

        // --- 1. S·∫¢N PH·∫®M (SERVER API) ---
        async function loadProducts() {
            try {
                if(allProducts.length === 0) { const res = await fetch(`${API_URL}/products`); allProducts = await res.json(); }
                renderTable();
            } catch (e) { console.error(e); }
        }

        function renderTable() {
            const tbody = document.getElementById('product-list'); tbody.innerHTML = '';
            const totalPages = Math.ceil(allProducts.length / itemsPerPage);
            if(currentPage > totalPages) currentPage = 1;
            const start = (currentPage - 1) * itemsPerPage;
            const viewData = allProducts.slice(start, start + itemsPerPage);

            viewData.forEach(p => {
                tbody.innerHTML += `<tr><td><img src="${p.image}" onerror="this.src='${DEFAULT_IMG}'"></td><td><b>${p.name}</b></td><td class="text-danger fw-bold">${Number(p.price).toLocaleString()}ƒë</td><td><span class="badge bg-info text-dark">${p.category || 'Kh√°c'}</span></td><td><button class="btn btn-sm btn-warning" onclick="openEditModal('${p._id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });

            const pag = document.getElementById('pagination'); pag.innerHTML = '';
            for(let i=1; i<=totalPages; i++){
                const btn = document.createElement('button'); btn.innerText = i;
                if(i===currentPage) btn.classList.add('active');
                btn.onclick = () => { currentPage = i; renderTable(); };
                pag.appendChild(btn);
            }
            document.getElementById('stat-products').innerText = allProducts.length;
        }

        // --- 2. ƒê∆†N H√ÄNG (FULL LOGIC) ---
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('allOrders')) || [];
            const activeBody = document.getElementById('active-order-body');
            const historyBody = document.getElementById('history-order-body');
            activeBody.innerHTML = ''; historyBody.innerHTML = '';
            let hasActive = false;

            orders.forEach((o) => {
                let summary = o.items.map(x => `- ${x.name} (x${x.quantity})`).join('<br>');
                let paymentBadge = o.payment === 'BANKING' ? '<span class="badge bg-primary">CK Ng√¢n H√†ng</span>' : '<span class="badge bg-success">COD</span>';
                
                if (o.status === 'pending' || o.status === 'shipping') {
                    hasActive = true;
                    let badgeClass = o.status === 'pending' ? 'status-pending' : 'status-shipping';
                    let statusText = o.status === 'pending' ? '‚è≥ Ch·ªù x·ª≠ l√Ω' : 'üöö ƒêang giao';
                    
                    // --- N√öT B·∫§M CHU·∫®N ---
                    let buttons = '';
                    if (o.status === 'pending') {
                        // Ch·ªù x·ª≠ l√Ω: ƒê∆∞·ª£c Giao ho·∫∑c H·ªßy
                        buttons = `<button class="btn btn-sm btn-primary mb-1" onclick="updateStt('${o.id}','shipping')"><i class="fas fa-truck"></i> Giao</button> <button class="btn btn-sm btn-secondary mb-1" onclick="updateStt('${o.id}','cancel')"><i class="fas fa-times"></i> H·ªßy</button>`;
                    } else {
                        // ƒêang giao: CH·ªà ƒê∆Ø·ª¢C Ho√†n th√†nh (M·∫•t n√∫t H·ªßy)
                        buttons = `<button class="btn btn-sm btn-success w-100" onclick="updateStt('${o.id}','done')"><i class="fas fa-check"></i> Xong</button>`;
                    }

                    activeBody.innerHTML += `
                        <tr>
                            <td class="fw-bold text-primary">#${o.id}</td>
                            <td><b>${o.customer}</b><br><small class="text-muted">${o.phone}</small><br><small class="text-danger"><i class="fas fa-map-marker-alt"></i> ${o.address || 'Ch∆∞a c√≥ ƒêC'}</small></td>
                            <td><small>${summary}</small><div class="mt-1">${paymentBadge}</div></td>
                            <td class="fw-bold text-danger">${Number(o.total).toLocaleString()}ƒë</td>
                            <td><span class="${badgeClass}">${statusText}</span></td>
                            <td>${buttons}</td>
                        </tr>`;
                } else {
                    let badgeClass = o.status === 'done' ? 'status-done' : 'status-cancel';
                    let statusText = o.status === 'done' ? '‚úÖ Xong' : '‚ùå H·ªßy';
                    historyBody.innerHTML += `<tr><td>#${o.id}</td><td>${o.customer}</td><td><small>${summary}</small></td><td>${Number(o.total).toLocaleString()}ƒë</td><td><span class="${badgeClass}">${statusText}</span></td></tr>`;
                }
            });
            document.getElementById('empty-active-msg').className = hasActive ? 'd-none' : 'text-center text-muted p-3';
            updateStats(orders);
        }

        function updateStt(id, st) {
            let orders = JSON.parse(localStorage.getItem('allOrders'));
            let idx = orders.findIndex(x => x.id === id);
            if(idx !== -1 && confirm("X√°c nh·∫≠n thay ƒë·ªïi?")) { orders[idx].status = st; localStorage.setItem('allOrders', JSON.stringify(orders)); loadOrders(); }
        }
        function clearOrders() { if(confirm("X√≥a h·∫øt?")) { localStorage.removeItem('allOrders'); loadOrders(); } }
        
        // --- TH·ªêNG K√ä & API ADD/EDIT ---
        function loadDashboard() { updateStats(JSON.parse(localStorage.getItem('allOrders'))||[]); }
        function updateStats(orders) {
            document.getElementById('stat-revenue').innerText = orders.filter(o=>o.status==='done').reduce((s,o)=>s+o.total,0).toLocaleString() + 'ƒë';
            document.getElementById('stat-orders').innerText = orders.length;
        }
        
        function openAddModal() { editingId=null; document.getElementById('productForm').reset(); document.getElementById('modalTitle').innerText="Th√™m M·ªõi"; productModalBox.show(); }
        function openEditModal(id) { const p = allProducts.find(x => x._id===id); editingId=id; document.getElementById('p-name').value=p.name; document.getElementById('p-price').value=p.price; document.getElementById('p-image').value=p.image; document.getElementById('modalTitle').innerText="S·ª≠a S·∫£n Ph·∫©m"; productModalBox.show(); }
        
        document.getElementById('productForm').addEventListener('submit', async(e)=>{ 
            e.preventDefault(); 
            const data = { name: document.getElementById('p-name').value, price: document.getElementById('p-price').value, image: document.getElementById('p-image').value, category: document.getElementById('p-category').value };
            try {
                if(editingId) await fetch(`${API_URL}/products/${editingId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                else await fetch(`${API_URL}/products`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                productModalBox.hide(); allProducts=[]; loadProducts(); alert("Th√†nh c√¥ng!");
            } catch(e){ alert("L·ªói l∆∞u!"); }
        });
        async function deleteProduct(id) { if(confirm("X√≥a?")) { await fetch(`${API_URL}/products/${id}`,{method:'DELETE'}); allProducts=[]; loadProducts(); } }
    </script>
</body>
</html>