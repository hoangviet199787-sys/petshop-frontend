<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng - Pet House</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .top-header { background: linear-gradient(90deg, #5b42f3, #7a5af8); padding: 10px 0; color: white; }
        .brand-logo { font-size: 1.8rem; font-weight: bold; color: white; text-decoration: none; }
        .main-menu { background-color: #263238; }
        .main-menu .nav-link { color: #cfd8dc; padding: 12px 30px; font-weight: 500; text-transform: uppercase; transition: 0.3s; }
        .main-menu .nav-link:hover { color: white; background-color: rgba(255,255,255,0.1); }
        .auth-links a { color: white; text-decoration: none; margin: 0 10px; }
        table img, .table img { width: 80px !important; height: 80px !important; object-fit: cover; border-radius: 5px; }
        .cart-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .total-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        footer { background-color: #263238; color: #cfd8dc; padding-top: 50px; margin-top: 50px; font-size: 0.9rem; border-top: 3px solid #1e272c; }
    </style>
</head>
<body>

    <header>
        <div class="top-header">
            <div class="container d-flex justify-content-between align-items-center">
                <a href="index.html" class="brand-logo"><i class="fas fa-paw"></i> Pet House</a>
                <div class="auth-links" id="auth-links">
                    <a href="login.html">ƒêƒÉng nh·∫≠p</a> | <a href="register.html">ƒêƒÉng k√Ω</a>
                </div>
            </div>
        </div>
        <div class="main-menu">
            <div class="container">
                <nav class="nav">
                    <a class="nav-link" href="index.html">Trang ch·ªß</a>
                    <a class="nav-link" href="products.html">S·∫£n ph·∫©m</a>
                    <a href="cart.html" class="nav-link text-warning fw-bold">
                        <i class="fas fa-shopping-cart me-1"></i> Gi·ªè h√†ng (<span id="cart-count">0</span>)
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mt-5">
        <h2 class="fw-bold mb-4 text-center">üõí Gi·ªè H√†ng C·ªßa B·∫°n</h2>
        <div class="row">
            <div class="col-md-8">
                <div class="cart-container">
                    <table class="table align-middle">
                        <thead><tr><th>S·∫£n ph·∫©m</th><th>ƒê∆°n gi√°</th><th>S·ªë l∆∞·ª£ng</th><th>Th√†nh ti·ªÅn</th><th>X√≥a</th></tr></thead>
                        <tbody id="cart-body"></tbody>
                    </table>
                    <div id="empty-cart-msg" class="text-center py-4 d-none">
                        <p class="text-muted">Gi·ªè h√†ng ƒëang tr·ªëng tr∆°n...</p>
                        <a href="products.html" class="btn btn-primary rounded-pill">ƒêi mua s·∫Øm ngay</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="total-box">
                    <h4 class="fw-bold mb-3">T·ªïng C·ªông</h4>
                    <div class="d-flex justify-content-between mb-2"><span>T·∫°m t√≠nh:</span><span class="fw-bold" id="sub-total">0ƒë</span></div>
                    <div class="d-flex justify-content-between mb-3"><span>Ph√≠ ship:</span><span class="text-success">Mi·ªÖn ph√≠</span></div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4"><h5 class="fw-bold">Th√†nh ti·ªÅn:</h5><h5 class="fw-bold text-danger" id="final-total">0ƒë</h5></div>
                    <button onclick="openCheckoutModal()" class="btn btn-dark w-100 py-2 fw-bold rounded-pill">TI·∫æN H√ÄNH ƒê·∫∂T H√ÄNG</button>
                    <a href="products.html" class="btn btn-outline-secondary w-100 mt-2 rounded-pill">Ti·∫øp t·ª•c mua h√†ng</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">Th√¥ng tin giao h√†ng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ng∆∞·ªùi nh·∫≠n</label>
                            <input type="text" class="form-control" id="ship-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" class="form-control" id="ship-phone" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-danger">ƒê·ªãa ch·ªâ giao h√†ng (*)</label>
                            <textarea class="form-control" id="ship-address" rows="2" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng X, Qu·∫≠n Y..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                            <div class="form-check p-3 border rounded mb-2">
                                <input class="form-check-input" type="radio" name="payment" id="cod" value="COD" checked>
                                <label class="form-check-label" for="cod"><i class="fas fa-money-bill-wave text-success me-2"></i> Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
                            </div>
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="payment" id="banking" value="BANKING">
                                <label class="form-check-label" for="banking"><i class="fas fa-university text-primary me-2"></i> Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
                            </div>
                        </div>
                        <div class="alert alert-info small" id="bank-info" style="display:none;">
                            <strong>Th√¥ng tin chuy·ªÉn kho·∫£n:</strong><br>
                            - Ng√¢n h√†ng: MB Bank<br>
                            - STK: 0999999999<br>
                            - N·ªôi dung: [SƒêT] Mua hang
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="confirmOrder()">X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let checkoutModalBox;

        window.onload = () => { 
            renderCart(); 
            checkUser(); 
            checkoutModalBox = new bootstrap.Modal(document.getElementById('checkoutModal'));
            
            // X·ª≠ l√Ω hi·ªán th√¥ng tin bank khi ch·ªçn chuy·ªÉn kho·∫£n
            document.querySelectorAll('input[name="payment"]').forEach(elem => {
                elem.addEventListener("change", function(event) {
                    document.getElementById('bank-info').style.display = event.target.value === "BANKING" ? "block" : "none";
                });
            });
        };

        // --- C√ÅC H√ÄM GI·ªé H√ÄNG C≈® ---
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = '';
            
            if (cart.length === 0) {
                document.getElementById('empty-cart-msg').classList.remove('d-none');
                document.querySelector('table').classList.add('d-none');
                updateTotal(0);
                return;
            } else {
                document.getElementById('empty-cart-msg').classList.add('d-none');
                document.querySelector('table').classList.remove('d-none');
            }

            let total = 0;
            cart.forEach((item, index) => {
                const rowTotal = item.price * item.quantity;
                total += rowTotal;
                tbody.innerHTML += `
                    <tr>
                        <td><div class="d-flex align-items-center"><img src="${item.image}"><span class="ms-3 fw-bold">${item.name}</span></div></td>
                        <td>${Number(item.price).toLocaleString()}ƒë</td>
                        <td>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, -1)">-</button>
                                <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-danger fw-bold">${rowTotal.toLocaleString()}ƒë</td>
                        <td><button class="btn btn-sm btn-danger rounded-circle" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
            updateTotal(total);
            document.getElementById('cart-count').innerText = cart.reduce((s,i)=>s+i.quantity,0);
        }

        function updateTotal(amount) {
            document.getElementById('sub-total').innerText = amount.toLocaleString() + 'ƒë';
            document.getElementById('final-total').innerText = amount.toLocaleString() + 'ƒë';
        }

        function changeQty(i, d) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart[i].quantity += d;
            if(cart[i].quantity < 1) cart[i].quantity = 1;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        function removeItem(i) {
            if(confirm("X√≥a m√≥n n√†y?")) {
                let cart = JSON.parse(localStorage.getItem('cart'));
                cart.splice(i, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }
        }

        function checkUser() {
            const user = JSON.parse(localStorage.getItem('user'));
            if(user) document.getElementById('auth-links').innerHTML = `Hi, <b>${user.username}</b> <a href="#" onclick="logout()" class="ms-1 text-warning">(Tho√°t)</a>`;
        }
        function logout() { localStorage.removeItem('user'); location.reload(); }

        // --- CH·ª®C NƒÇNG THANH TO√ÅN M·ªöI ---
        function openCheckoutModal() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const user = JSON.parse(localStorage.getItem('user'));

            if (cart.length === 0) { alert("Gi·ªè h√†ng ƒëang tr·ªëng!"); return; }
            if (!user) { alert("Vui l√≤ng ƒêƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n!"); window.location.href = "login.html"; return; }

            // ƒêi·ªÅn s·∫µn th√¥ng tin kh√°ch v√†o Modal
            document.getElementById('ship-name').value = user.username;
            document.getElementById('ship-phone').value = user.phoneNumber || user.phone || "";
            
            checkoutModalBox.show();
        }

        function confirmOrder() {
            const address = document.getElementById('ship-address').value.trim();
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const user = JSON.parse(localStorage.getItem('user'));
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const totalAmount = cart.reduce((s, i) => s + (i.price * i.quantity), 0);

            if (!address) {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!");
                return;
            }

            // T·∫†O ƒê∆†N H√ÄNG (C√≥ th√™m ƒë·ªãa ch·ªâ + ph∆∞∆°ng th·ª©c thanh to√°n)
            const newOrder = {
                id: 'DH' + Math.floor(Math.random() * 10000),
                customer: user.username,
                phone: user.phoneNumber || "09xxxxxxxxx",
                address: address, // <--- M·ªöI
                payment: paymentMethod, // <--- M·ªöI (COD ho·∫∑c BANKING)
                date: new Date().toLocaleString('vi-VN'),
                items: cart,
                total: totalAmount,
                status: 'pending'
            };

            // L∆∞u v√†o danh s√°ch ƒë∆°n h√†ng
            let allOrders = JSON.parse(localStorage.getItem('allOrders')) || [];
            allOrders.unshift(newOrder);
            localStorage.setItem('allOrders', JSON.stringify(allOrders));

            // X√≥a gi·ªè & Th√¥ng b√°o
            localStorage.removeItem('cart');
            checkoutModalBox.hide();
            
            let msg = `‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!\nM√£ ƒë∆°n: ${newOrder.id}`;
            if(paymentMethod === 'BANKING') msg += "\n\nVui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin ƒë√£ cung c·∫•p ƒë·ªÉ shop x·ª≠ l√Ω nhanh h∆°n.";
            
            alert(msg);
            window.location.reload();
        }
    </script>
</body>
</html>