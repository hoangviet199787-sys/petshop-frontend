<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sản Phẩm - Pet House</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        
        /* HEADER */
        .top-header { background: linear-gradient(90deg, #5b42f3, #7a5af8); padding: 10px 0; color: white; }
        .brand-logo { font-size: 1.8rem; font-weight: bold; color: white; text-decoration: none; }
        .main-menu { background-color: #263238; }
        .main-menu .nav-link { color: #cfd8dc; padding: 12px 30px; font-weight: 500; text-transform: uppercase; transition: 0.3s; }
        .main-menu .nav-link:hover { color: white; background-color: rgba(255,255,255,0.1); }
        .auth-links a { color: white; text-decoration: none; margin: 0 10px; }

        /* FILTER BOX (KHUNG LỌC GIÁ) */
        .filter-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        /* PRODUCT CARD */
        .product-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; height: 100%; position: relative; cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .product-card img { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; }
        .badge-hot { position: absolute; top: 10px; right: 10px; background: #ff4757; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }

        /* FOOTER */
        footer { background-color: #263238; color: #cfd8dc; padding-top: 50px; margin-top: 50px; font-size: 0.9rem; border-top: 3px solid #1e272c; }
    </style>
</head>
<body>

    <header>
        <div class="top-header">
            <div class="container d-flex justify-content-between align-items-center">
                <a href="index.html" class="brand-logo"><i class="fas fa-paw"></i> Pet House</a>
                <div class="auth-links" id="auth-links">
                    <a href="login.html">Đăng nhập</a> | <a href="register.html">Đăng ký</a>
                </div>
            </div>
        </div>
        <div class="main-menu">
            <div class="container">
                <nav class="nav">
                    <a class="nav-link" href="index.html">Trang chủ</a>
                    <a class="nav-link text-warning fw-bold" href="products.html">Sản phẩm</a>
                    <a class="nav-link" href="contact.html">Liên hệ</a>
                    <a href="cart.html" class="nav-link">
                        <i class="fas fa-shopping-cart me-1"></i> Giỏ hàng (<span id="cart-count">0</span>)
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <div class="filter-box">
            <h5 class="fw-bold mb-3"><i class="fas fa-filter text-primary"></i> Bộ lọc tìm kiếm</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold">Tên sản phẩm</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-keyword" class="form-control" placeholder="Nhập tên thức ăn, phụ kiện...">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Giá thấp nhất (VNĐ)</label>
                    <input type="number" id="min-price" class="form-control" placeholder="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Giá cao nhất (VNĐ)</label>
                    <input type="number" id="max-price" class="form-control" placeholder="Ví dụ: 500000">
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary w-100 fw-bold" onclick="filterProducts()">LỌC NGAY</button>
                </div>
            </div>
            <div class="mt-2 text-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetFilter()">Làm mới bộ lọc</button>
            </div>
        </div>

        <h3 class="fw-bold mb-4 ps-2 border-start border-4 border-primary">Danh Sách Sản Phẩm (<span id="result-count">0</span>)</h3>
        <div class="row g-4" id="product-list">
            </div>
        <div id="no-result" class="text-center py-5 d-none">
            <img src="https://cdn-icons-png.flaticon.com/512/6134/6134065.png" width="100">
            <p class="mt-3 text-muted">Không tìm thấy sản phẩm nào trong khoảng giá này!</p>
        </div>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body pb-5">
                    <div class="row">
                        <div class="col-md-6"><img id="modal-img" src="" class="img-fluid rounded" style="width:100%;"></div>
                        <div class="col-md-6">
                            <h3 id="modal-name" class="fw-bold mt-3"></h3>
                            <h2 id="modal-price" class="text-danger fw-bold my-3"></h2>
                            <p class="text-muted">Sản phẩm chính hãng, chất lượng cao.</p>
                            <button id="modal-add-btn" class="btn btn-primary rounded-pill w-100"><i class="fas fa-cart-plus"></i> THÊM VÀO GIỎ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer><div class="container text-center py-4 text-secondary">© 2025 Pet House</div></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://petshop-api-3uon.onrender.com/api";
        const DEFAULT_IMG = "https://cdn-icons-png.flaticon.com/512/3047/3047928.png";
        
        let allProducts = []; // Biến chứa toàn bộ sản phẩm gốc
        let detailModal;

        window.onload = async () => {
            detailModal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            await fetchProducts();
            checkUser();
            updateHeaderCount();
        };

        // 1. Tải toàn bộ sản phẩm từ API
        async function fetchProducts() {
            try {
                const res = await fetch(`${API_URL}/products`);
                allProducts = await res.json();
                renderGrid(allProducts); // Hiển thị tất cả ban đầu
            } catch(e) { console.error("Lỗi tải:", e); }
        }

        // 2. Hàm lọc sản phẩm (LOGIC QUAN TRỌNG)
        function filterProducts() {
            // Lấy giá trị từ các ô nhập
            const keyword = document.getElementById('search-keyword').value.toLowerCase().trim();
            let minPrice = document.getElementById('min-price').value;
            let maxPrice = document.getElementById('max-price').value;

            // Xử lý nếu khách không nhập giá (để trống)
            if (minPrice === "") minPrice = 0;
            if (maxPrice === "") maxPrice = 999999999; // Số cực lớn

            minPrice = Number(minPrice);
            maxPrice = Number(maxPrice);

            // Lọc danh sách
            const filteredData = allProducts.filter(p => {
                const matchName = p.name.toLowerCase().includes(keyword);
                const matchPrice = p.price >= minPrice && p.price <= maxPrice;
                return matchName && matchPrice;
            });

            renderGrid(filteredData);
        }

        // 3. Reset bộ lọc về mặc định
        function resetFilter() {
            document.getElementById('search-keyword').value = "";
            document.getElementById('min-price').value = "";
            document.getElementById('max-price').value = "";
            renderGrid(allProducts);
        }

        // 4. Hiển thị lưới sản phẩm
        function renderGrid(products) {
            const container = document.getElementById('product-list');
            const noResult = document.getElementById('no-result');
            const countSpan = document.getElementById('result-count');
            
            container.innerHTML = '';
            countSpan.innerText = products.length;

            if (products.length === 0) {
                noResult.classList.remove('d-none');
                return;
            } else {
                noResult.classList.add('d-none');
            }

            container.innerHTML = products.map(p => `
                <div class="col-md-3 col-6">
                    <div class="product-card" onclick="showDetail('${p._id}')">
                        <img src="${p.image}" onerror="this.src='${DEFAULT_IMG}'">
                        <div class="text-muted small">${p.category || 'Khác'}</div>
                        <h6 class="fw-bold text-truncate">${p.name}</h6>
                        <div class="text-danger fw-bold fs-5">${Number(p.price).toLocaleString()}đ</div>
                        <button onclick="event.stopPropagation(); addToCart('${p._id}', '${p.name}', ${p.price}, '${p.image}')" class="btn btn-dark w-100 mt-2 btn-sm rounded-pill"><i class="fas fa-shopping-bag me-1"></i> Mua</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Các hàm phụ trợ (Giỏ hàng, User...) ---
        function showDetail(id) {
            const p = allProducts.find(x => x._id === id);
            if(p) {
                document.getElementById('modal-img').src = p.image;
                document.getElementById('modal-name').innerText = p.name;
                document.getElementById('modal-price').innerText = Number(p.price).toLocaleString() + 'đ';
                const btn = document.getElementById('modal-add-btn');
                btn.onclick = () => { addToCart(p._id, p.name, p.price, p.image); detailModal.hide(); };
                detailModal.show();
            }
        }

        function addToCart(id, name, price, image) {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                if(confirm("Bạn cần Đăng Nhập để mua hàng. Chuyển đến trang đăng nhập?")) window.location.href = "login.html";
                return;
            }
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let item = cart.find(i => i.id === id);
            if(item) item.quantity++; else cart.push({id, name, price, image, quantity:1});
            localStorage.setItem('cart', JSON.stringify(cart));
            updateHeaderCount();
            alert("Đã thêm vào giỏ!");
        }

        function updateHeaderCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            document.getElementById('cart-count').innerText = cart.reduce((s,i)=>s+i.quantity,0);
        }

        function checkUser() {
            const user = JSON.parse(localStorage.getItem('user'));
            if(user) document.getElementById('auth-links').innerHTML = `Hi, <b>${user.username}</b> <a href="change-password.html"><i class="fas fa-key text-white mx-2"></i></a> <a href="#" onclick="logout()" class="text-warning">(Thoát)</a>`;
        }
        function logout() { localStorage.removeItem('user'); location.reload(); }
    </script>
</body>
</html>